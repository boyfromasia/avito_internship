# Микросервис для работы с балансом пользователей

## Стек

* **Язык разработки:** _Golang_
* **БД:** _PostgreSQL_
* **REST API фреймворк:** _Gin_
* **Миграция:** _golang-migrate_
* **Драйвер БД:** _sqlx_

## Структура Проекта

![alt text](img/1.png)

## Архитектура БД

* Orders - История только покупок юзеров, без пополнения счета (Могут иметь три статуса: _waited, cancelled, approved_)
* Purchases - Наименование покупок
* HistoryUser - История только подтвержденных транзакций для всех юзеров
* User - Баланс юзера


![alt text](img/db.png)

#### Все таблицы были созданы пустыми, кроме _Purchases. Purchases_ имеет две записи.


| purchaseid | name  |
|------------|-------|
| 1          | Candy |
| 2          | Beer  |

## Запуск

```
docker-compose up
```

## Запросы

### Реализовано

#### Минимум

* Метод начисления средств на баланс. **POST /user**

* Метод получения баланса пользователя. **GET /user**

* Метод отправки средств другому пользователю. **POST /user/transaction**

* Метод резервирования средств с основного баланса на отдельном счете. **POST /order/create**

* Метод признания выручки – списывает из резерва деньги, добавляет данные в отчет для бухгалтерии. **POST /order/decision**

#### Доп. Задание

* Метод получения списка транзакций с комментариями откуда и зачем были начислены/списаны средства с баланса. **GET /history**

### Не реализовано

#### Доп. Задание

* Метод получения списка транзакций с комментариями откуда и зачем были начислены/списаны средства с баланса.


## Примеры


* **POST /user**

Метод начисления средств на баланс. Если пользователя не было в базе, создастся новый с указанным балансом,
если пользоватеь есть, средства начилсятся на баланс. Поле _balance_ валидируется, он может быть только > 0.

Также добавляется запись в таблицу _HistoryUser_ с комментарием _"Add to balance from persona X"_.

Пример:


```json
{
    "user_id": 111,
    "balance": 321
}
```

Возвращает: 

```json
{
    "status": "OK"
}
```


* **GET /user** 

Метод получения баланса пользователя.

Пример:


```json
{
  "user_id": 111
}
```

Возвращает:

```json
{
  "balance": 121
}
```

* **POST /user/transaction**

Метод отправки средств другому пользователю. Поля валидируются. Юзеры должны быть в БД.
Сумма не может быть < 0. Также на счету отправляющего должно быть достаточно средств.

Еще добавляется запись в таблицу _HistoryUser_ с комментарием _"Add to balance from user $id"_ и
_"Send money to user %id"_ вдля принимающего и отправляющего соответственно.

Пример:

```json
{
    "from_id": 1,
    "to_id": 2,
    "amount": 200
}
```

Возвращает:

```json
{
  "status": "OK"
}
```


* **POST /order/create**

Метод резервирования средств с основного баланса на отдельном счете. Поле _price_ валидируется. Он может быть только > 0.
_status_ этого заказа будет _waited_.

Пример:

```json
{
  "order_id": 4,
  "user_id": 111,
  "purchase_id": 1,
  "price": 1
}
```

Возвращает:

```json
{
    "status": "OK"
}
```


* **POST /order/decision**

Метод признания выручки – списывает из резерва деньги, добавляет данные в отчет для бухгалтерии.
Проверяет по всем полям есть ли такой заказ. Поле _decision_ может быть _"cancelled"_
или _"approved"_. Поле _decision_ валидируется, то есть уже признанные покупки не могут поменять статус. 

Также добавляется запись в таблицу _HistoryUser_ с комментарием _"approve purchase %name_purchase"_ если поле
_decision = approved_

Пример:


```json
{
  "order_id": 4,
  "user_id": 111,
  "purchase_id": 1,
  "decision": "cancelled",
  "price": 1
}
```

Возвращает:

```json
{
    "status": "OK"
}
```

* **GET /history**

Метод получения списка транзакций с комментариями откуда и зачем были начислены/списаны средства с баланса.
Поля _sort_type, sort_col, offset, limit_ - необязательные поля. _sort_col_ принимает значения 
_timecreated_ и _cost_.  _sort_col_ принимает значения _ASC_ и _DESC_. _sort_col_ и _offset_ > 0. _offset и 
limit_ работают как в sql.


Пример сортировки:

```json
{
  "user_id": 1,
  "sort_type": "DESC",
  "offset": 0,
  "limit": 0,
  "sort_col": "cost"
}
```
Возвращает:
```json
{
  "history": [
    {
      "cost": 1000,
      "comment": "Add to balance from persona X",
      "time_created": "2022-11-10T17:50:00.851679Z"
    },
    {
      "cost": 200,
      "comment": "Add to balance from 2",
      "time_created": "2022-11-10T17:50:15.679202Z"
    },
    {
      "cost": -101,
      "comment": "approve purchase Beer",
      "time_created": "2022-11-10T17:50:24.816949Z"
    },
    {
      "cost": -500,
      "comment": "approve purchase Beer",
      "time_created": "2022-11-10T17:50:42.639901Z"
    }
  ]
}
```

Пример пагинации 1:

```json
{
    "user_id": 1,
    "sort_type": "DESC",
    "offset": 2,
    "limit": 0,
    "sort_col": "cost"
}
```
Возвращает:

```json
{
    "history": [
        {
            "cost": -101,
            "comment": "approve purchase Beer",
            "time_created": "2022-11-10T17:50:24.816949Z"
        },
        {
            "cost": -500,
            "comment": "approve purchase Beer",
            "time_created": "2022-11-10T17:50:42.639901Z"
        }
    ]
}
```

Пример пагинации 2:

```json
{
    "user_id": 1,
    "sort_type": "DESC",
    "offset": 2,
    "limit": 1,
    "sort_col": "cost"
}
```

Возвращает:

```json
{
    "history": [
        {
            "cost": -101,
            "comment": "approve purchase Beer",
            "time_created": "2022-11-10T17:50:24.816949Z"
        }
    ]
}
```
